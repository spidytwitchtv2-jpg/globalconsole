<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Console App</title>
    <style>
        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            margin: 0;
            padding: 20px;
            font-size: 14px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        h1 {
            margin: 0;
            color: #4CAF50;
            font-size: 16px;
            text-align: left;
        }
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid #4CAF50;
            border-radius: 4px;
            overflow: hidden;
        }
        .toggle-btn {
            padding: 8px 16px;
            background-color: transparent;
            color: #4CAF50;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .toggle-btn.active {
            background-color: #4CAF50;
            color: white;
        }
        .toggle-btn:first-child {
            border-right: 1px solid #4CAF50;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 30px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
        .view-label {
            color: #4CAF50;
            font-size: 12px;
            font-weight: bold;
        }
        .controls {
            display: flex;
            gap: 10px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        .console-container {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: opacity 0.15s ease;
        }
        .console-item {
            display: flex;
            flex-direction: column;
            padding: 12px 0;
            border-bottom: 1px solid #444;
            animation: pushIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform-origin: top;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        
        .console-item-row {
            display: flex;
            width: 100%;
            margin-bottom: 5px;
        }
        
        .console-item-row:last-child {
            margin-bottom: 0;
        }
        
        .console-item-row.top-row {
            align-items: center;
        }
        
        .console-item-row.bottom-row {
            align-items: center;
        }
        .console-item::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        @keyframes pushIn {
            0% {
                opacity: 0;
                transform: scaleY(0.8) translateY(-20px);
                background-color: transparent;
            }
            50% {
                opacity: 1;
                transform: scaleY(1.05) translateY(-5px);
            }
            100% {
                opacity: 1;
                transform: scaleY(1) translateY(0);
                background-color: transparent;
            }
        }
        .new-item {
            animation: pushInNew 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        .new-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, rgba(76, 175, 80, 0.3), rgba(76, 175, 80, 0.1), transparent);
            animation: highlightSlide 0.8s ease-out forwards;
            z-index: -1;
        }
        @keyframes pushInNew {
            0% {
                opacity: 0;
                transform: scaleY(0.8) translateY(-30px);
                background-color: rgba(76, 175, 80, 0.2);
            }
            50% {
                opacity: 1;
                transform: scaleY(1.1) translateY(5px);
                background-color: rgba(76, 175, 80, 0.3);
            }
            100% {
                opacity: 1;
                transform: scaleY(1) translateY(0);
                background-color: rgba(76, 175, 80, 0.1);
            }
        }
        @keyframes highlightSlide {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        @keyframes pushOut {
            0% {
                opacity: 1;
                transform: scaleY(1) translateY(0);
            }
            100% {
                opacity: 0;
                transform: scaleY(0.8) translateY(20px);
            }
        }
        .console-item:last-child {
            border-bottom: none;
        }
        .app-name {
            flex: 0 0 auto;
            font-weight: bold;
            min-width: 0; /* Allow flex items to shrink below content size */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
        }
        .carrier {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0; /* Allow flex items to shrink below content size */
        }
        .carrier .sms {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
            color: #ccc;
            margin: 0;
            padding: 0;
            min-width: 0; /* Allow flex items to shrink below content size */
        }
        .copy-btn {
            background-color: #555;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .copy-btn:hover {
            background-color: #666;
        }
        .time {
            flex: 0 0 auto;
            text-align: right;
            color: #aaa;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
            white-space: nowrap;
            margin-left: 10px;
        }
        
        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .console-item {
                padding: 10px 0;
                display: flex;
                flex-direction: column;
            }
            
            .console-item-row {
                display: flex;
                width: 100%;
                margin-bottom: 5px;
            }
            
            .console-item-row:last-child {
                margin-bottom: 0;
            }
            
            .console-item-row.top-row {
                align-items: center;
            }
            
            .console-item-row.bottom-row {
                align-items: center;
            }
            
            .app-name {
                flex: 0 0 auto;
                margin-right: 10px;
            }
            
            .carrier {
                flex: 1;
                display: flex;
                align-items: center;
                min-width: 0;
            }
            
            .carrier .sms {
                margin-left: 10px;
                flex: 1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .time {
                flex: 0 0 auto;
                text-align: left;
                font-size: 11px;
                margin-left: 10px;
            }
            
            .copy-btn {
                padding: 4px 8px;
                font-size: 11px;
                flex-shrink: 0;
            }
        }
        .status {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        .status.active {
            background-color: #4CAF50;
        }
        .status.pending {
            background-color: #ff9800;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #aaa;
        }
        /* Accordion Styles */
        .accordion-container {
            display: none;
        }
        .accordion-container.active {
            display: block;
        }
        .list-container {
            display: block;
        }
        .list-container.hidden {
            display: none;
        }
        .accordion-group {
            margin-bottom: 10px;
            border: 1px solid #444;
            border-radius: 6px;
            overflow: hidden;
        }
        .accordion-header {
            background-color: #3a3a3a;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background-color 0.2s;
        }
        .accordion-header:hover {
            background-color: #444;
        }
        .accordion-header.active {
            background-color: #4a4a4a;
        }
        .accordion-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }
        .accordion-count {
            background-color: #555;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: #aaa;
        }
        .accordion-icon {
            transition: transform 0.3s;
            color: #aaa;
        }
        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background-color: #2d2d2d;
        }
        .accordion-content.active {
            max-height: 5000px;
            transition: max-height 0.5s ease-in;
        }
        .accordion-messages {
            padding: 10px 15px;
        }
        .accordion-item {
            padding: 10px 0;
            border-bottom: 1px solid #3a3a3a;
        }
        .accordion-item:last-child {
            border-bottom: none;
        }
        .accordion-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .accordion-item-sms {
            color: #ccc;
            font-size: 14px;
            margin-top: 5px;
        }
        /* Grid View Styles */
        .grid-container {
            display: block;
        }
        .grid-container.hidden {
            display: none;
        }
        .grid-layout {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            padding: 10px 0;
        }
        .grid-card {
            background-color: #3a3a3a;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .grid-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .card-logo {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .card-app-name {
            font-weight: bold;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card-time {
            font-size: 12px;
            color: #aaa;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background-color: #2d2d2d;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #444;
        }
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }
        .close-modal {
            background: none;
            border: none;
            color: #aaa;
            font-size: 24px;
            cursor: pointer;
        }
        .modal-body {
            padding: 20px;
        }
        .modal-message {
            padding: 10px 0;
            border-bottom: 1px solid #444;
        }
        .modal-message:last-child {
            border-bottom: none;
        }
        
        .modal-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .modal-number-copy {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Mobile-specific styles for modal */
        @media (max-width: 768px) {
            .modal-message-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .modal-number-copy {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .time {
                align-self: flex-end;
                font-size: 11px;
            }
        }
        
        /* Toast notification styles */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Console App</h1>
            <div class="toggle-container">
                <button class="toggle-btn active" id="listViewBtn">
                    <span>üìã List</span>
                </button>
                <button class="toggle-btn" id="gridViewBtn">
                    <span>üìä Grid</span>
                </button>
            </div>
        </header>
        
        <!-- Modal for displaying messages -->
        <div id="messageModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="modalTitle">Messages</h2>
                    <button class="close-modal" id="closeModal">&times;</button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Messages will be loaded here -->
                </div>
            </div>
        </div>
        
        <div class="console-container">
            <div id="listView" class="list-container">
                <div id="consoleData">
                    <div class="loading">Loading data...</div>
                </div>
            </div>
            <div id="accordionView" class="accordion-container">
                <div id="accordionData">
                    <div class="loading">Loading data...</div>
                </div>
            </div>
            <div id="gridView" class="grid-container hidden">
                <div id="gridData">
                    <div class="loading">Loading data...</div>
                </div>
            </div>
        </div>
            
        <!-- Toast notification -->
        <div id="toast" class="toast">Text copied!</div>
    </div>

    <script>
        // Global variables
        let lastData = null;
        let refreshInterval = null;
        let currentView = 'list'; // 'list', 'accordion', or 'grid'
        let isFirstLoad = true; // Track if this is the first load

        // DOM elements
        const consoleDataElement = document.getElementById('consoleData');
        const accordionDataElement = document.getElementById('accordionData');
        const listViewElement = document.getElementById('listView');
        const accordionViewElement = document.getElementById('accordionView');
        const gridViewElement = document.getElementById('gridView');
        const listViewBtn = document.getElementById('listViewBtn');
        const gridViewBtn = document.getElementById('gridViewBtn');
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const closeModal = document.getElementById('closeModal');
        
        // Animation tracking
        let previousMessages = [];

        // Format time ago with Bangladesh timezone conversion
        function timeAgo(timeInput) {
            // Handle case where we only have time without date
            if (!timeInput || timeInput === 'unknown time') {
                return 'unknown time';
            }
            
            // Convert to string if it's not already
            const timeString = String(timeInput);
            
            // If timeString is a time-only format like "20:23:24"
            if (timeString.includes(':') && !timeString.includes('-')) {
                // Parse the time string assuming it's from today
                const today = new Date();
                
                // Get Bangladesh time (UTC+6)
                const bdOffset = 6 * 60; // Bangladesh is UTC+6 in minutes
                const utc = today.getTime() + (today.getTimezoneOffset() * 60000);
                const bdTime = new Date(utc + (bdOffset * 60000));
                
                const [hours, minutes, sec] = timeString.split(':').map(Number);
                
                if (!isNaN(hours) && !isNaN(minutes)) {
                    // Create date object with the time string (assuming it's in Bangladesh time)
                    const date = new Date(bdTime.getFullYear(), bdTime.getMonth(), bdTime.getDate(), hours, minutes, sec || 0);
                    
                    // Calculate time difference using Bangladesh time
                    const diffMs = bdTime - date;
                    const secondsElapsed = Math.floor(diffMs / 1000);
                    
                    // Handle negative time (future time) - show as "Just now"
                    if (secondsElapsed < 0) {
                        return "Just now";
                    }
                    
                    // Return relative time in proper format
                    if (secondsElapsed < 60) {
                        return Math.floor(secondsElapsed) + "s ago BDT";
                    } else if (secondsElapsed < 3600) {
                        const mins = Math.floor(secondsElapsed / 60);
                        return mins + "m ago BDT";
                    } else if (secondsElapsed < 86400) {
                        const hrs = Math.floor(secondsElapsed / 3600);
                        return hrs + "h ago BDT";
                    } else {
                        // More than a day, just show the time with BDT
                        return timeString + " BDT";
                    }
                } else {
                    // Invalid time format, return as-is with BDT
                    return timeString + " BDT";
                }
            }
            
            // If it's a full datetime string, convert it
            const date = timeInput instanceof Date ? timeInput : new Date(timeInput);
            if (isNaN(date.getTime())) {
                return timeString + " BDT"; // Return as-is if invalid
            }
            
            // Convert to Bangladesh time for comparison
            const bdOffset = 6 * 60; // Bangladesh is UTC+6 in minutes
            const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
            const bdDateTime = new Date(utc + (bdOffset * 60000));
            
            const bdNow = new Date();
            const utcNow = bdNow.getTime() + (bdNow.getTimezoneOffset() * 60000);
            const bdCurrentTime = new Date(utcNow + (bdOffset * 60000));
            
            const seconds = Math.floor((bdCurrentTime - bdDateTime) / 1000);
            
            // Handle negative time (future time) - show as "Just now"
            if (seconds < 0) {
                return "Just now";
            }
            
            // Less than 60 seconds
            if (seconds < 60) {
                return Math.floor(seconds) + "s ago BDT";
            }
            
            // Less than 1 hour
            if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                return minutes + "m ago BDT";
            }
            
            // Less than 1 day
            if (seconds < 86400) {
                const hours = Math.floor(seconds / 3600);
                return hours + "h ago BDT";
            }
            
            // Less than 1 week
            if (seconds < 604800) {
                const days = Math.floor(seconds / 86400);
                return days + "d ago BDT";
            }
            
            // More than 1 week
            const weeks = Math.floor(seconds / 604800);
            return weeks + "w ago BDT";
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Text copied!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy text');
            });
        }
        
        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Generate emoji/logo based on app name
        function getAppLogo(appName) {
            const logos = {
                'Facebook': 'üìò',
                'Google': 'üîç',
                'Twitter': 'üê¶',
                'Instagram': 'üì∏',
                'LinkedIn': 'üëî',
                'Snapchat': 'üëª',
                'WhatsApp': 'üí¨',
                'Telegram': '‚úàÔ∏è',
                'TikTok': 'üéµ',
                'YouTube': 'üì∫',
                'Amazon': 'üì¶',
                'Netflix': 'üé¨',
                'Spotify': 'üéß',
                'Microsoft': 'üíª',
                'Apple': 'üçé',
                'Samsung': 'üì±',
                'PayPal': 'üí∞',
                'Bank': 'üè¶',
                'OTP': 'üî¢',
                'Code': 'üîë'
            };
            
            // Check for exact matches first
            if (logos[appName]) return logos[appName];
            
            // Check for partial matches
            for (const [key, logo] of Object.entries(logos)) {
                if (appName.toLowerCase().includes(key.toLowerCase())) {
                    return logo;
                }
            }
            
            // Default logo
            return 'üì±';
        }

        // Render console data in list view
        function renderConsoleData(data) {
            if (!data || !data.messages || data.messages.length === 0) {
                consoleDataElement.innerHTML = '<div class="loading">No data available</div>';
                return;
            }

            // On first load, show all items at once
            if (isFirstLoad) {
                updateFullList(data.messages);
                isFirstLoad = false;
                // Update previous messages for next comparison
                previousMessages = [...data.messages];
                return;
            }

            // Create a map of previous messages for comparison
            const previousMessageMap = {};
            previousMessages.forEach((msg, index) => {
                previousMessageMap[`${msg.app_name}-${msg.carrier}-${msg.time}`] = index;
            });
            
            // Find new messages
            const newMessages = [];
            const existingMessages = [];
            
            data.messages.forEach((item, index) => {
                const messageKey = `${item.app_name}-${item.carrier}-${item.time}`;
                if (!(messageKey in previousMessageMap)) {
                    newMessages.push(item);
                } else {
                    existingMessages.push(item);
                }
            });
            
            // If we have new messages, animate them in
            if (newMessages.length > 0) {
                // Add new items at the top with animation
                newMessages.forEach((item, index) => {
                    setTimeout(() => {
                        addNewItemToTop(item);
                    }, index * 100); // Stagger the animations
                });
            } else {
                // No new messages, just update the list normally
                updateFullList(data.messages);
            }
            
            // Update previous messages for next comparison
            previousMessages = [...data.messages];
        }
        
        // Add a new item to the top with animation
        function addNewItemToTop(item) {
            // Use the color from the data or default to white
            const appColor = item.color || '#ffffff';
            
            // Extract only the numeric part for copying
            let carrierNumber = item.carrier;
            const numericPart = item.carrier.replace(/[^0-9]/g, '');
            // For ranges like 236724XXX, we want to show 236724XXXX
            if (numericPart.length >= 6) {
                carrierNumber = numericPart.substring(0, 6) + 'XXXX';
            } else if (numericPart.length > 0) {
                carrierNumber = numericPart + 'XXXX';
            } else {
                carrierNumber = 'XXXX';
            }
            
            // Create new item element
            const newItem = document.createElement('div');
            newItem.className = 'console-item new-item';
            newItem.innerHTML = `
                <div class="app-name" style="color: ${appColor}">${item.app_name}</div>
                <div class="carrier" title="${item.carrier}">
                    ${carrierNumber}
                    <button class="copy-btn" onclick="copyToClipboard('${carrierNumber}')">Copy</button>
                    <span class="sms">${item.sms}</span>
                </div>
                <div class="time">${timeAgo(item.time)}</div>
            `;
            
            // Add to the top of the list
            consoleDataElement.insertBefore(newItem, consoleDataElement.firstChild);
            
            // Remove last item to maintain list length (simulate push effect)
            if (consoleDataElement.children.length > 20) { // Keep max 20 items
                const lastItem = consoleDataElement.lastChild;
                if (lastItem && lastItem.classList.contains('console-item')) {
                    lastItem.style.animation = 'pushOut 0.3s ease-out forwards';
                    setTimeout(() => {
                        if (lastItem.parentNode) {
                            lastItem.parentNode.removeChild(lastItem);
                        }
                    }, 300);
                }
            }
        }
        
        // Update the full list (fallback when no new items)
        function updateFullList(messages) {
            let html = '';
            messages.forEach(item => {
                // Use the color from the data or default to white
                const appColor = item.color || '#ffffff';
                
                // Extract only the numeric part for copying
                let carrierNumber = item.carrier;
                const numericPart = item.carrier.replace(/[^0-9]/g, '');
                // For ranges like 236724XXX, we want to show 236724XXXX
                if (numericPart.length >= 6) {
                    carrierNumber = numericPart.substring(0, 6) + 'XXXX';
                } else if (numericPart.length > 0) {
                    carrierNumber = numericPart + 'XXXX';
                } else {
                    carrierNumber = 'XXXX';
                }
                
                html += `
                <div class="console-item">
                    <div class="console-item-row top-row">
                        <div class="app-name" style="color: ${appColor}">${item.app_name}</div>
                        <div class="carrier" title="${item.carrier}">
                            ${carrierNumber}
                            <button class="copy-btn" onclick="copyToClipboard('${carrierNumber}')" title="Copy to clipboard">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="console-item-row bottom-row">
                        <span class="sms">${item.sms}</span>
                        <div class="time">${timeAgo(item.time)}</div>
                    </div>
                </div>
                `;
            });
            
            consoleDataElement.innerHTML = html;
        }

        // Render console data in accordion view (grouped by app_name)
        function renderAccordionData(data) {
            if (!data || !data.messages || data.messages.length === 0) {
                accordionDataElement.innerHTML = '<div class="loading">No data available</div>';
                return;
            }

            // Group messages by app_name
            const grouped = {};
            data.messages.forEach(item => {
                const appName = item.app_name || 'Unknown';
                if (!grouped[appName]) {
                    grouped[appName] = {
                        color: item.color || '#ffffff',
                        messages: [],
                        latestTime: new Date(item.time || Date.now())
                    };
                }
                grouped[appName].messages.push(item);
                // Update latest time
                const itemTime = new Date(item.time || Date.now());
                if (itemTime > grouped[appName].latestTime) {
                    grouped[appName].latestTime = itemTime;
                }
            });

            // Sort groups by latest message time (newest first)
            const sortedGroups = Object.entries(grouped).sort((a, b) => {
                return b[1].latestTime - a[1].latestTime;
            });

            let html = '';
            sortedGroups.forEach(([appName, group]) => {
                const appColor = group.color;
                const messageCount = group.messages.length;
                
                // Sort messages within group by time (newest first)
                group.messages.sort((a, b) => {
                    const timeA = new Date(a.time || 0).getTime();
                    const timeB = new Date(b.time || 0).getTime();
                    return timeB - timeA;
                });

                html += `
                <div class="accordion-group">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="accordion-title">
                            <span style="color: ${appColor}">${appName}</span>
                            <span class="accordion-count">${messageCount}</span>
                        </div>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-messages">
                            ${group.messages.map(item => `
                                <div class="accordion-item">
                                    <div class="accordion-item-header">
                                        <div class="carrier" title="${item.carrier}">
                                            ${(() => {
                                                const numericPart = item.carrier.replace(/[^0-9]/g, '');
                                                const carrierNumber = numericPart.length >= 6 ? numericPart.substring(0, 6) + 'XXXX' : numericPart.length > 0 ? numericPart + 'XXXX' : 'XXXX';
                                                return carrierNumber;
                                            })()}
                                            <button class="copy-btn" onclick="copyToClipboard('${(() => {
                                                const numericPart = item.carrier.replace(/[^0-9]/g, '');
                                                const carrierNumber = numericPart.length >= 6 ? numericPart.substring(0, 6) + 'XXXX' : numericPart.length > 0 ? numericPart + 'XXXX' : 'XXXX';
                                                return carrierNumber;
                                            })()}')" title="Copy to clipboard">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                                                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="time">${timeAgo(item.time)}</div>
                                    </div>
                                    <div class="accordion-item-sms">${item.sms}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                `;
            });

            accordionDataElement.innerHTML = html;
        }

        // Toggle accordion
        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            header.classList.toggle('active');
            content.classList.toggle('active');
        }

        // Toggle view between list, accordion, and grid
        function toggleView(view) {
            // Update active button
            if (view === 'list') {
                listViewBtn.classList.add('active');
                gridViewBtn.classList.remove('active');
            } else if (view === 'grid') {
                listViewBtn.classList.remove('active');
                gridViewBtn.classList.add('active');
            }
            
            currentView = view;
            
            // Hide all views
            listViewElement.classList.add('hidden');
            accordionViewElement.classList.remove('active');
            if (gridViewElement) gridViewElement.classList.add('hidden');
            
            // Show selected view
            if (currentView === 'accordion') {
                accordionViewElement.classList.add('active');
                if (lastData) {
                    renderAccordionData(lastData);
                }
            } else if (currentView === 'grid') {
                if (gridViewElement) gridViewElement.classList.remove('hidden');
                if (lastData) {
                    renderGridData(lastData);
                }
            } else {
                listViewElement.classList.remove('hidden');
                if (lastData) {
                    renderConsoleData(lastData);
                }
            }
        }

        // Refresh token
        async function refreshToken() {
            try {
                const response = await fetch('/api/refresh-token');
                const data = await response.json();
                
                if (response.ok) {
                    return data.token;
                } else {
                    throw new Error(data.detail || 'Failed to refresh token');
                }
            } catch (error) {
                console.error('Error refreshing token:', error);
                // Don't show alert, just log the error and continue
                return null;
            }
        }

        // Fetch console data
        async function fetchConsoleData() {
            try {
                const response = await fetch('/api/console-data');
                const data = await response.json();
                
                if (response.ok) {
                    // Only update if we have new data
                    if (data && data.data) {
                        lastData = data.data;
                        // Render based on current view
                        if (currentView === 'accordion') {
                            renderAccordionData(lastData);
                        } else if (currentView === 'grid') {
                            renderGridData(lastData);
                        } else {
                            renderConsoleData(lastData);
                        }
                        
                        // Update modal if it's open
                        if (messageModal.classList.contains('active')) {
                            // The modal will automatically update when reopened
                        }
                    } else if (lastData) {
                        // Keep showing old data on failure
                        if (currentView === 'accordion') {
                            renderAccordionData(lastData);
                        } else if (currentView === 'grid') {
                            renderGridData(lastData);
                        } else {
                            renderConsoleData(lastData);
                        }
                    }
                } else {
                    throw new Error(data.detail || 'Failed to fetch data');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                // Keep showing old data on failure
                if (lastData) {
                    if (currentView === 'accordion') {
                        renderAccordionData(lastData);
                    } else if (currentView === 'grid') {
                        renderGridData(lastData);
                    } else {
                        renderConsoleData(lastData);
                    }
                } else {
                    // If no previous data, show a more user-friendly message
                    const targetElement = currentView === 'accordion' ? accordionDataElement : 
                                         currentView === 'grid' ? gridViewElement : consoleDataElement;
                    targetElement.innerHTML = '<div class="loading">Waiting for data...</div>';
                }
            }
        }

        // Auto-refresh every 5 seconds
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(async () => {
                const token = await refreshToken();
                // Even if token refresh fails, still try to fetch data
                await fetchConsoleData();
            }, 5000);
        }

        // Render console data in grid view
        function renderGridData(data) {
            if (!data || !data.messages || data.messages.length === 0) {
                gridViewElement.innerHTML = '<div class="loading">No data available</div>';
                return;
            }

            // Group messages by app_name
            const grouped = {};
            data.messages.forEach(item => {
                const appName = item.app_name || 'Unknown';
                if (!grouped[appName]) {
                    grouped[appName] = {
                        color: item.color || '#ffffff',
                        messages: [],
                        latestTime: new Date(item.time || Date.now())
                    };
                }
                grouped[appName].messages.push(item);
                // Update latest time
                const itemTime = new Date(item.time || Date.now());
                if (itemTime > grouped[appName].latestTime) {
                    grouped[appName].latestTime = itemTime;
                }
            });

            // Sort groups by latest message time (newest first)
            const sortedGroups = Object.entries(grouped).sort((a, b) => {
                return b[1].latestTime - a[1].latestTime;
            });

            let html = '<div class="grid-layout">';
            sortedGroups.forEach(([appName, group]) => {
                const appColor = group.color;
                const messageCount = group.messages.length;
                const latestMessage = group.messages[0]; // Already sorted
                const latestTime = timeAgo(latestMessage.time);
                const appLogo = getAppLogo(appName);
                
                html += `
                <div class="grid-card" onclick="openModal('${appName}', ${JSON.stringify(group.messages).replace(/"/g, '&quot;')})">
                    <div class="card-logo">${appLogo}</div>
                    <div class="card-app-name">${appName}</div>
                    <div class="card-time">${latestTime}</div>
                </div>
                `;
            });
            html += '</div>';

            gridViewElement.innerHTML = html;
        }
        
        // Open modal with messages
        function openModal(appName, messages) {
            modalTitle.textContent = `${appName} Messages`;
            
            // Sort messages by time (newest first)
            messages.sort((a, b) => {
                const timeA = new Date(a.time || 0).getTime();
                const timeB = new Date(b.time || 0).getTime();
                return timeB - timeA;
            });
            
            let html = '';
            messages.forEach(item => {
                const numericPart = item.carrier.replace(/[^0-9]/g, '');
                const carrierNumber = numericPart.length >= 6 ? numericPart.substring(0, 6) + 'XXXX' : numericPart.length > 0 ? numericPart + 'XXXX' : 'XXXX';
                html += `
                <div class="modal-message">
                    <div class="modal-message-header">
                        <div class="modal-number-copy">
                            <strong>${carrierNumber}</strong>
                            <button class="copy-btn" onclick="copyToClipboard('${carrierNumber}')" title="Copy to clipboard">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                                </svg>
                            </button>
                        </div>
                        <div class="time">${timeAgo(item.time)}</div>
                    </div>
                    <div style="margin-top: 8px;">${item.sms}</div>
                </div>
                `;
            });
            
            modalBody.innerHTML = html;
            messageModal.classList.add('active');
        }
        
        // Close modal
        function closeMessageModal() {
            messageModal.classList.remove('active');
        }
        
        // Event listeners
        listViewBtn.addEventListener('click', () => toggleView('list'));
        gridViewBtn.addEventListener('click', () => toggleView('grid'));
        closeModal.addEventListener('click', closeMessageModal);
        messageModal.addEventListener('click', (e) => {
            if (e.target === messageModal) {
                closeMessageModal();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Show loading message
            consoleDataElement.innerHTML = '<div class="loading">Initializing application...</div>';
            
            try {
                // Perform initial login
                const loginResponse = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'Aktermamber.00.7@gmail.com',
                        password: 'Bd55555$'
                    })
                });
                
                if (!loginResponse.ok) {
                    throw new Error('Login failed');
                }
                
                // Initial load
                await refreshToken();
                await fetchConsoleData();
                
                // Start auto-refresh
                startAutoRefresh();
            } catch (error) {
                console.error('Initialization error:', error);
                consoleDataElement.innerHTML = '<div class="loading">Error initializing application. Please refresh the page.</div>';
            }
        });
    </script>
</body>
</html>